var gridUsr001 = null;

function initSelect() {
	commonGetHospital("", "", true);
	
	getNewUser();
}

//신청 계정 조회
function getNewUser() {
	const params = {
		"hospitalCode" : document.getElementById("hospitalCode").value,
		"officeCode"   : document.getElementById("officeCode").value,
		"user" 		   : document.getElementById("user").value,
		"useYn"        : 'P'
	};	
	
    commonAjax.call("/usr/getOfficeUserList", "POST", params, function(data) {
    	const result = data.resultList;
    	
    	if (data.message == "OK") {
    		const clickBtn = function(cell, formatterParams, onRendered) { //plain text value
        		let btn = "";
        		btn += "<button type='button' class='btn-user-ok'>승인</button>";
        		btn	+= "<button type='button' class='btn-user-no'>거부</button>";
        		return btn;    		
        	};
        	        	
        	if (isNullStr(gridUsr001)) {
        		//Grid draw
            	gridUsr001 = new Tabulator("#divGrid", {    				    			
    			    layout: "fitColumns",
    				pagination: "local",
    				paginationSize: 15,
    				paginationButtonCount:9,
    				placeholder: "해당 데이터가 없습니다.",    				
    				maxHeight:"100%",
        		    columns: [
        		    	{title: "아이디(ID)"  , field: "sysUserId" , resizable:false , minWidth:100, hozAlign: "center", headerSort: false},
        		    	{title: "이름"		  , field: "sysName"   , resizable:false , hozAlign: "center", headerSort: false},
        		    	{title: "병원"		  , field: "officeLocation", resizable:false , hozAlign: "center", headerSort: false},
        		    	{title: "직책"		  , field: "posName"   , resizable:false , hozAlign: "center", headerSort: false},
        		    	{title: "휴대폰 번호" , field: "mobile" , resizable:false , minWidth:150 , hozAlign: "center", headerSort: false,
        		    		formatter:function(cell) {
        		    			if (!isNullStr(cell.getValue())) {
        		    				return cell.getValue().replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);	
        		    			}        		    			
        		    		}		    	
        		    	},
        			    {title: "가입 신청일"   , field: "createDate" , resizable:false , minWidth:250 , hozAlign: "center", headerSort: false},
        			    {formatter: clickBtn  , resizable:false , minWidth:200 , hozAlign: "center", headerSort: false, cellClick:function(e, cell){ userAuthorization(e, cell); }}
        		    ]			  
        		});

        		//Data set
            	gridUsr001.on("tableBuilt", function(){				
            		gridUsr001.setData(result);			    				
        		});	
        	} else {        		
        		gridUsr001.clearData();
        		gridUsr001.setData(result);
        	}        	        	
    	}    	
    });		    
}

//계정 신청 승인 버튼 클릭 popup
function userAuthorization(e, cell) {
	let params = {};
	
	if (e.target.className === "btn-user-ok") {		//승인 버튼
		params = {
				"sysUserId"	: cell._cell.row.data.sysUserId,
				"sysMobile"	: cell._cell.row.data.mobile
		};
		
		commonDrawPopup("load", "/usr/usr003Popup", params);
	} else {										//거부 버튼
		if (confirm('승인 거부하시겠습니까?')) {
			params = {
					"sysUserId"	: cell._cell.row.data.sysUserId,
					"sysMobile"	: cell._cell.row.data.mobile,
					"useYn"		: "N"
			};
			
			commonAjax.call("/usr/userRegisterProc", "POST", params, function(data) {
				if (data.message == "OK") {
					getNewUser();
					popupClose();
				} else {
					alert(data.message);
				}
			});
		}
	}
}

//최종 승인
function authorizeUserAccount() {
	const menuArr   = [];
	const menu = document.querySelectorAll('.check-wrap > div');
	
	for (let i = 0; i < menu.length; i++) {
		if (menu[i].classList.contains('active')) {
			menuArr.push(menu[i].dataset.code);
		}
	}
	
	params =  {
			"sysUserId"	: document.getElementById('sysUserId').value,
			"sysMobile"	: document.getElementById('sysMobile').value,
			"useYn"		: "Y",
			"authCheck" : document.getElementById('2ndAccess').checked ? "Y" : "N",
			"menuList"	: JSON.stringify(menuArr)
	}
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
	if (isNullStr(menuArr)) {
		alert('메뉴 권한 1개 이상 필수 선택입니다.');
        return;
	}
	
	commonAjax.call("/usr/userRegisterProc", "POST", params, function(data) {
		if (data.message == "OK") {
			getNewUser();
			popupClose();
		} else {
			alert(data.message);
			popupClose();
		}
	});
}

function drawMenuCode() {
	const area = document.querySelector('.check-wrap');
	
	//메뉴 권한 설정
	commonAjax.call("/menu/getMenuCode", "POST", "", function(data){
		if (data.message == "OK") {			
			const result = data.resultList;			
			area.innerHTML = "";
			
			for (let i = 0; i < result.length; i++) {
				area.innerHTML +=
					`<div class="menu-auth-btn" data-code=${result[i].menuCode}>${result[i].menuName}</div>`;	
			}
			getAutoMenu();
		}
	});
}

function getAutoMenu() {
	const menu = document.querySelectorAll('.check-wrap div');

	for (let i = 0; i < menu.length; i++) {
		menu[i].addEventListener('click', function(){
			menu[i].classList.toggle('active');
		});
	}
}